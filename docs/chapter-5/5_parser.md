### Chapter 5: SQL to physical plan, parse and run

#### 5.1 解析器概述

在数据库系统中，解析器与执行器的作用紧密相关。当数据库系统需要执行一条查询执行时，需要通过结构化查询语言（SQL）描述这一查询过程传递给解析器。解析器的主要功能在于解析输入的SQL语句并将其转化为一套高效的物理执行计划交由执行器完成。内部的工作流程可以概括为3个部分：
1. 词法语法分析：SQL语句到抽象语法树
2. 逻辑优化：抽象语法树到逻辑计划树
3. 物理优化：逻辑计划树到物理执行计划

经过词法和语法分析，SQL语句可以转化为抽象语法树，这一部分是编译原理课程的主要内容，期间不需要考虑数据库系统的设计和底层存储结构等任何与数据库系统实现相关的内容。所以这一部分不作为本课程关注的重点。根据我们所给出的语法文件，直接利用antlr的访问者模式可以比较轻松地完成这一步转化工作。

数据库解析器的特色在于其抽象语法树的后续处理过程，与编译器和解释器不同，此处不会结合系统和虚拟机特性转化为某种编码格式，而是需要结合数据库的一些统计信息和存储结构，在可能面临的很多种执行方案中规划出一套相对较优的实际物理执行计划并传递给执行器完成这一工作。这一部分包含了逻辑优化和物理优化两个过程，这一部分将成为各位同学思考的重点。

#### 5.2 SQL语法简介

结构化查询语言(Structured Query Language)简称SQL，是一种数据库查询和程序设计语言，用于存取数据以及查询、更新和管理关系数据库系统；同时也是数据库脚本文件的扩展名。SQL是一门 ANSI 的标准计算机语言，用来访问和操作数据库系统。虽然作为一种数据库语言的基准，但是工业界数据库厂商大多都在SQL基准基础之上进行了一定程度的变化和拓展，导致了当今存在了大量不同版本的SQL文法规范。本次实验任务中，同学们仅需要重点关注于SQL语言中有关于**数据操作语言（DML）**和**数据定义语言（DDL）**的部分重点文法结构。

所有需要支持的文法已经在**sql.g4**文件中给出，文法对应的功能可以参阅文法手册。

由于SQL语句转抽象语法树的部分是编译原理课程已经充分研究的内容，所以第一个转化阶段不作为本次实验的重点内容，可以直接基于给出的文法文件利用antlr的访问者模式生成这一部分代码。解析器部分重点的实验内容为逻辑优化和物理优化的过程。

#### 5.3 逻辑优化：抽象语法树到逻辑计划树

查询优化器在逻辑优化阶段主要解决的问题是：如何找出SQL语句的等价变换形式，使SQL执行更高效；一般可以使用代数优化的方式完成这一过程。代数优化是通过关系代数中一些等价变化的方式调整原始的抽象语法树结构，使其变化为执行过程上更为简洁高效的逻辑计划树的形式。主要是一些基于规则的固定转化模式，逻辑优化过程基于如下的经验规则：
1. 尽早进行选择运算，这样可以尽早降低运算数据的规模
2. 合并同表的多个选择和投影运算，减少表的扫描次数
3. 合并投影运算和其他双目运算（笛卡尔积，等值连接，并集差集），减少表的扫描次数
4. 合并选择运算与笛卡尔积，避免直接计算笛卡尔积
5. 提取公共子表达式，重复使用
   
基于上述的经验规则，常用的变化包括如下几类：
1. 列裁剪：运算过程中仅保留必要的列，忽略其余列，降低数据传输开销。
2. 谓词下推：将查询语句中的过滤表达式计算尽可能下推到距离数据源最近的地方，以尽早完成数据的过滤，进而显著地减少数据传输或计算的开销。
3. 子查询合并：在语义等价条件下，多个子查询可以合并成一个子查询，这样多次表扫描，多次连接减少为单次表扫描和单次连接。
4. 谓词重写：利用一些等价规则将IN、OR、LIKE、BETWEEN、AND等谓词进行等价转化。
5. 条件化简：对于WHERE、HAVING等条件进行化简，例如常量传递和不等式变化等。

#### 5.4 物理优化：查询计划树到物理执行计划

代数优化改变查询语句中操作的次序和组合，但不涉及底层的存取路径。物理优化就是要选择高效合理的操作算法或存取路径，求得优化的查询计划，达到查询优化的目标。

查询优化器在物理优化阶段，主要解决的问题是：

- 从可选的单表扫描方式中，挑选什么样的单表扫描方式最优？
- 对于两表连接，如何连接最优？
- 对于多表连接，哪种连接顺序最优？
- 对于多表连接，是否需要对每种连接顺序都探索？如果不全部探索，如何找到一种最优组合？

可以选择基于规则的启发式优化或基于代价估算的优化。基于规则的启发式算法一般相对简单，优化效果一般但是速度较快，适合于解释执行的系统，查询优化和查询执行同时进行。编译执行的方式则是先进行编译优化后整体执行，查询优化和查询执行分离，此时使用基于代价估算的优化更容易获得更好的优化效果，但是可能会面临执行计划的选择空间很大，优化时间开销过高的问题。而将两者结合，先使用启发式算法限制候选空间，对于候选空间内的方案进行代价估计，这样可以在较短时间内获得一个相对较优的执行计划。



#### 5.5 对外提供的接口
1. pa::parse() // 抽象语法树到查询计划树
2. pa::excute() // 查询计划树到物理执行计划